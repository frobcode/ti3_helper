<HTML>
<HEAD>
    <SCRIPT language="javascript" src="data/techtree.js" ></SCRIPT>
    <SCRIPT language="javascript" src="src/dependency_mapper.js" ></SCRIPT>
    <SCRIPT language="javascript">
        function return_span(tech)
        {
            // this will return a span element that has the settings right for a tech
            var spanTag = document.createElement("span");
            spanTag.id = "tech_" + tech.sn;

            var titleSpan = document.createElement("span");
            titleSpan.id="tech_title_" + tech.sn;
            titleSpan.className = "techTitle";
            titleSpan.innerHTML = tech.fn;
            titleSpan.title = tech.d;
            spanTag.appendChild(titleSpan);

            var have = document.createElement("input");
            have.id="tech_have_" + tech.sn;
            have.type = "checkbox";
            have.onclick=function() { onCheckboxClick( tech ) };
            spanTag.appendChild(have);

            var dist = document.createElement("span");
            dist.id="tech_distance_"+tech.sn;
            dist.innerHTML="";
            dist.title = prereqs_as_string(tech);
            spanTag.appendChild(dist);

            return spanTag;
        }

        function sorted_techlist(with_techtree)
        {
            var toReturn = [];
            for(var ttiter in with_techtree)
            {
                toReturn.push(with_techtree[ttiter]);
            }

            toReturn.sort(function( a, b) { return (a.fn<b.fn)? -1:1});
               
            return toReturn;
        }

        function onCheckboxClick(tech) 
        {
            var checkBox = document.getElementById("tech_have_" + tech.sn);
            tech.have = checkBox.checked;
            update_availability(tech, tech_updated);
        }

        // this is called back from update_availability, as things get touched
        function tech_updated(tech)
        {
            set_properties(tech);
        }

        function refresh_the_world(with_tree)
        {
            set_availables(with_tree);
            for( var treeiter in with_tree)
            {
                var tech = with_tree[treeiter];
                set_properties(tech);
            }
        }

        function set_properties(tech)
        {
            var shortName = tech.sn;
            var spanClass = "techSpan " + (tech.have ? " have" : (tech.distance < 2)?" available":" notAvailable");
            var span = document.getElementById("tech_" + shortName);
            span.className = spanClass;
            var have = document.getElementById("tech_have_" + shortName);
            have.checked = tech.have;
            have.disabled = (tech.distance > 1);
            var distance = get_tech_distance(tech);
            var dist = document.getElementById("tech_distance_" + shortName);
            dist.innerHTML="" + distance;
        }

        function initial_population(with_techtree, div_to_add_to)
        {
            // find the 'techs' identifier
            // and then make an element per tech
            // with indication if it is enabled and available
            var to_iter = sorted_techlist(with_techtree);
            for( var tech in to_iter )
            {
                var newSpan = return_span(to_iter[tech]);
                div_to_add_to.appendChild(newSpan);
                set_properties(to_iter[tech])
            }
        }
    </SCRIPT>
    <TITLE>This is a test</TITLE>
    <style type="text/css" >
        *.have { color: green }
        *.available { color: blue  }
        *.notAvailable {color: red }
        *.techSpan {display:block }
    </style>
</HEAD>
<BODY>
    Frob o la
    <div id="techs">

    </div>
    <SCRIPT language="javascript" >
    
        var tech_tree = create_tech_tree(techtree);
        var techs_div = document.getElementById("techs");
        initial_population( tech_tree, techs_div);
</SCRIPT>
</BODY>
</HTML>
